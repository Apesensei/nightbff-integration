# CI Governance

## Package Lock Management

### ⚠️ CRITICAL: Do Not Hand-Edit package-lock.json

**NEVER manually edit `package-lock.json`**. This file is automatically generated and must remain synchronized with `package.json` across all workspaces.

### ✅ Correct Workflow

1. **Update dependencies**: Modify `package.json` files in submodules
2. **Regenerate lock**: Run `npm install --workspaces` from integration root
3. **Commit changes**: Include both `package.json` and `package-lock.json` changes
4. **Verify CI**: Ensure CI passes before merging

### 🔧 Workspace Commands

```bash
# From integration root
npm install --workspaces          # Regenerate lock across all workspaces
npm ci --ignore-scripts          # Verify lock matches package.json
npm audit fix                    # Apply non-breaking security fixes
```

### 🚨 Common Issues

- **CI fails with npm ci errors**: Lock file out of sync with package.json
- **Missing dependencies**: Submodule updated but root lock not regenerated
- **Version conflicts**: Multiple package.json files specify different versions

### 📋 CI Validation

The CI pipeline includes automatic validation:

- `npm ci --ignore-scripts` verifies lock file consistency
- Workspace dependency resolution is checked
- Submodule synchronization is validated

### 🔄 Recovery Process

If lock file becomes corrupted:

1. Delete `node_modules` and `package-lock.json`
2. Run `npm install --workspaces`
3. Commit the regenerated `package-lock.json`
4. Verify CI passes

## Frontend Docker Build

### 🐳 Docker Configuration

The frontend uses a multi-stage Docker build:

1. **Builder stage**: Installs dependencies and builds the web bundle
2. **Nginx stage**: Serves the static files

### 📁 File Structure

```
nightbff-integration/
├── Dockerfile.frontend          # Frontend Docker build file
├── .dockerignore.frontend       # Docker ignore patterns
├── docker-compose.yaml          # Multi-service orchestration
└── nightbff-frontend/          # Frontend submodule (source)
```

### 🔧 Build Commands

```bash
# Local build
docker build -f Dockerfile.frontend -t nightbff-frontend:local nightbff-frontend/

# CI build (uses buildx for multi-platform)
docker buildx build --platform linux/amd64 --file Dockerfile.frontend --context nightbff-frontend --tag ghcr.io/apesensei/nightbff-frontend:int-${{ steps.vars.outputs.frontend_sha }} --push .
```

### 🧪 Testing Strategy

- **Unit tests**: Run in CI with `--testPathIgnorePatterns=".*\\.native\\..*"`
- **Web build validation**: Verify HTML and JS bundles are served
- **Bundle size check**: Fail if bundle exceeds 10MB
- **Health checks**: Verify frontend responds on port 8081

### 🚨 Common Issues

- **Native module imports**: Use platform-specific files (`.web.tsx`, `.native.tsx`)
- **Bundle size**: Monitor and optimize dependencies
- **Build failures**: Check for missing dependencies or syntax errors

---

**Last Updated**: October 3, 2025  
**Related**: PR #30 (lockfile synchronization fix), PR #33 (frontend Docker integration)
