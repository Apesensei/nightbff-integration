name: NightBFF Integration CI (Digest)

on:
  workflow_dispatch:
    inputs:
      backend_digest:
        description: "Backend image digest (sha256:...)"
        required: true
        type: string
      frontend_digest:
        description: "Frontend image digest (sha256:...)"
        required: true
        type: string

permissions:
  contents: read
  packages: read

jobs:
  integration_tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate compose.override.yml
        run: |
          cat > compose.override.yml <<'EOC'
          services:
            migrator:
              image: ghcr.io/apesensei/nightbff-backend@${{ inputs.backend_digest }}
              depends_on:
                db:
                  condition: service_healthy
              env_file:
                - ./config/integration.env
              command: ["sh", "-lc", "npm run migration:run:compiled && node dist/scripts/run-seeder.js"]
              restart: "no"
            backend:
              image: ghcr.io/apesensei/nightbff-backend@${{ inputs.backend_digest }}
              env_file: [ ./config/integration.env ]
              ports: [ "3000:3000" ]
              depends_on:
                migrator:
                  condition: service_completed_successfully
            frontend:
              image: ghcr.io/apesensei/nightbff-frontend@${{ inputs.frontend_digest }}
              ports: [ "8081:80" ]
          EOC

      - name: Start infra and services
        run: docker compose up -d --Wait

      - name: Wait for backend health
        run: timeout 120 bash -c 'until curl -f http://localhost:3000/health; do sleep 2; done'

      - name: Wait for frontend health
        run: timeout 120 bash -c 'until curl -f http://localhost:8081; do sleep 2; done'

      - name: Validate basic endpoints
        run: |
          curl -f http://localhost:3000/api/performance/metrics
          curl -f http://localhost:3000/api/docs

      - name: Teardown
        if: always()
        run: docker compose down -v || true


