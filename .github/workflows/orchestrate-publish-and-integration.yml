name: Orchestrate Publish & Integration

on:
  workflow_dispatch:
  push:
    branches: ["main", "develop", "integration/**"]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  backend_publish:
    uses: Apesensei/nightbff-backend/.github/workflows/build-publish-backend.yml@main
    permissions:
      contents: read
      packages: write
      id-token: write
    secrets: inherit

  frontend_publish:
    uses: Apesensei/nightbff-frontend/.github/workflows/build-publish-frontend.yml@master
    permissions:
      contents: read
      packages: write
      id-token: write
    secrets: inherit

  integration_tests:
    needs: [backend_publish, frontend_publish]
    uses: ./.github/workflows/integration-ci.yml
    with:
      backend_digest: ${{ needs.backend_publish.outputs.digest }}
      frontend_digest: ${{ needs.frontend_publish.outputs.digest }}
    secrets: inherit

